
# ssmjp 2018/05 メモ&感想
[[toc]]

### @arctanx93さん KYTの話
- 途中参加…
- サーバ運用のヒヤリハットで非常にあるあるがいっぱいあって、明文化とルールづくりは大事だな、と感じた

### NRI 中島さん　続・広く知ってほしいDNSのこと
- https://www.slideshare.net/nakatomoorg/ssmjpdnssecurity2/
- やったね、6000Viewこえたよ！ホッテントリだよ！
- DNS Summit Day 2018 やるよ！
- レジストラとかやるよ！難しいよ！
- 明日が最終出社日…
- DNSのメカニズムおさらい
    - 分散データベースだよ！
    - 名前解決するよ！
    - ネームサーバ
        - ゾーン情報を保持・管理・公開するためのサーバ、権威サーバっていうよ！
- 今日のやっていき
    - レジストラント・レジストラ・レジストリ 登録者・登録取次事業者・登録管理期間
    - WHOIS
        - ドメインハイジャックへの対策
    - レジストリロック・レジストラロック・レジストラ各社コンパネの認証機能強化
        - ClientHoldｺﾜｲ
            - 一時的に利用制限しました! 情報おかしいよ!認証できてないよ!
    - 夏のbind祭りお疲れさまでした
    - 地震のとき、庁舎の中に権威が2台ともあって、冗長化しててもつながらなかった
    - MyEtherWalletで盗難されたやつ→DNSSECがあって、RPKIがあったら多分防げた
    - DNSブロッキングの話。やっぱりエンジニアが不幸になる、ユーザも不幸になる。
- まとめ
空気なようなものだけど、壊れたら影響が広範囲になりがちだから理解や関心を高めてください！
- おまけ: 深センいってきたよ! 楽しかった!

### @shutingrzさん 「DNSトンネリングの話」(仮）
- DNSの闇の話
- とあるSOCのエンジニア
    - #ssmjp初参加が先月
- HOMENOCとピアリングしてるって!
- ドメインロック! FBIから止められた!おのれFBI!
- DNSトンネリング
    - DNS通信に別の目的を持った情報を含めること
    - 暗号化通信とは違う、偽装通信
    - 意味のあるデータを送信していることを知られないようにする
    - 利用例: フィルタ環境下でのVPNやマルウェア
- マルウェアについて話します
    - マルウェアがHTTP通信する理由
        1. ほとんどのOSで可能
        1. プロキシがあっても抜けられる
        1. 様々なデータを柔軟に表現できる
    - DNS通信でも同じ
    - マルウェアの通信例
        - いっぱいある!9割以上標的型になってる!
    - マルウェアの特徴からわかるトンネリングの手法
        - サーバからクライアントへの命令はTXTが多い
            - 任意データを含められるから
        - クライアントからサーバはqname
    - デモ!
        - AレコードでC2通信
        - TXTレコードでC2通信
        - Wiresharkでパケット見てたらおもしれー
    - マルウェア作成者を出し抜けるか?
        - 直接通信する場合
            - なんでもできる
            - フォレンジッカーにバレないように
            - EDNS0使うとqnameに出てこないのでバレにくい
            - デモ!
        - キャッシュサーバを経由する場合
        - フルリゾルバを経由する場合
            - 再起問い合わせに不要なデータは削除される
            - 同じqnameとRRはTTL秒キャッシュされる→マルウェア作成者からすると超じゃま
        - サーバからクライアント
            - TXTレコード
                - 大きすぎるとバレる
                - もともとギリ許せたがこうも使われてはダメになってきた
            - RRSIG
                - 流れていてもギリ許されそう
                - 200バイトくらいが現実的
            - CNAME
                - qtypeがAなのに文字列が返ってきてよいのが良い
                - 自ゾーンの名前を示してwildcardすれば返ってくるので不審性が抑えられる
        - クライアントからサーバ
            - qname
                - フルリゾルバはスタブリゾルバのQUESTION SETIONのみを再帰問い合わせする
                - qname, qclass, qtypeのみ
                - 結局qnameにするしかない
                - qnameを見とけば検知できる!
        - 検出するには
            - フルリゾルバを経由する場合
                - サーバからクライアント
                    - 普段使わないRRか
                    - サイズが大きくないか
                    - RCODEがNOERROR以外
                    - TTLが小さくないか
                - クライアントからサーバ
                    - qnameの長さ
                    - ドメインの長さ
                    - qnameの不審さ
                        - 文字/単語のランダム性や符号化検知
                            - 複雑性が高いとおかしい
                            - 単語の関連性をスコアリング
                                - ここらへんはinfobloxが特許持ってるらしい
- まとめ
    - DNSトンネリングがひっそりと使われている
    - ロギングされないから標的型攻撃に使われる
    - 直接通信できる場合は検知が非常に難しい
        - フルリゾルバから以外をフィルタすればOK
    - qnameを見よう

- QA
    - AAAAは?
        - まだ少ないから見つかりやすいんじゃね?
    - ロギングって何を指してる?
        - BINDのクエリログとか
            - あーそりゃ取らないわ…

### @tcshさん 「宣言型デプロイツールの「正しい」使い方 (考え方編)」
- あくまでも一つの見方です！建設的な議論をしましょう！
- interopでも話すよ！JANOGでも話すよ！
- 運用自動化は運用標準化の一つ
    - 社内製手運用
    - 自動化すれば定型化されるわけではない、手順書を飛ばしてはいけない。各実装に独自性が出てしまう
    - 自動化ツール不具合時の手動対応まで想定するのがプロの自動化
- 宣言型デプロイツールとは
    - AWS Cloud Formation が今回のメイン
    - Ansible、Chef、etc
- メリット
    1. 再現性が高い
    1. 操作がシンプルになる（移管可能）
    1. 再利用性が高い（配布可能）
- Cloud Formationの印象
    - コレジャナイ感が消えない
        - 実運用とコンセプトのギャップが埋まらない
- 落とし穴がある
    - 管理職から任せられてしまい、実装者とメンバーのコミュニケーションだけという構図になりがち
    - 実装者ノリノリ、メンバー雰囲気に流される
    - テンプレ・レシピ属人化、隠れた運用でカバーが発生
    - 設計時のマルチリージョンが途中までだったときの運用でカバー、とかあるある感がすごい
    - Whyは復元できないことが多い
        - 処理内容は分かっても意図がわからない
        - 今動いてるものが止まるわけではないけど、次のデプロイまでが制限時間にのリバエンすることになる
- 宣言型デプロイツール界隈で気づいたこと
    - ノリノリな人の10割はイイね！っていってる
    - 引き継いだけどイイねってなってる人見たこと無い
    - ChefからAnsible実装者になった人多数! しぬ! 身にしみてしぬ!
    - 引き継いだけどイイねって人を探してるので連絡ください
        - 適切なドキュメントが一緒に納品されたケースは成功事例として唯一聞いたことがある
        - やっぱりドキュメント必要
        - あとは引き継がなくていい環境の人…
    - ほとんど引き継ぎ失敗してるように見えるので、やっぱりドキュメント必要だよ
    - 引き継げない自動化はプロの仕事ではない
- 宣言型デプロイツールにおける二律背反
    - 再現性！ゴリゴリ自動化！
    - 汎用性！標準化！全部これでデプロイするぜ！
        - これが組み合わさると、3～4年後、メンテできない標準ツール、汎用性もいまいち、何かと手間がかかるコレジャナイ感
    - デプロイツールに何を求めたいのか?
        - 再現性? 汎用性? 両立させようとするとほぼ確実に破綻する（あくまでも経験と観測の結果）
        - 本番環境が確実に上がるのが個人的な期待
        - 汎用性ホントいる? いらなくね?
- 汎用性、不都合な真実
    1. 範囲が不明な汎用性は未定義と同義
    1. 汎用性の定義はうまくいかない
    1. 汎用性の確保はうまくいかない
- 再現性の意外な真実
    - 汎用性と多機能と変更や更新をやらないと再現性が高くなるよ
- まとめ
    - デプロイツールに求めるべきなのは再現性だと思ってるよ！
    - 汎用性にこだわると、メリット1とメリット2は失われることに注意
    - 自動化に必要なことは手順とコードが連動していること
    - ドキュメントいるよ！
    - 再現性を軸にしようね！
- 次回予告
    - 再現性はツールで、汎用性はプロセスで
    - テンプレートは使い捨て!
- QA
    - ツールがすぐ使い古されてしまっててどうなのかなーと。ラッパーでよくないすか?
        - 生で叩くのはそろそろ意味ないかなーと思ってて、そろそろオーサリングツールになるのか?とは思っている。テンプレートは使い捨て、生成工程を作るツールがほしいかなと
    - CloudFormation多機能すぎるからアレじゃなーと。k8sはきっちりわかれてる感あってよさそうでは?
        - コンテナはまだキャッチアップできてないのでやっていきしたいです。やっぱりコンテナのようなもので閉じ込めたりとかすると分けやすいよね。
        - CloudFormationまだ全部カバーできてないので結局キメラ化しやすい。
        - koyhogeさん話してください！（質問者がkoyhogeさん）

### 感想
いやー、DNSトンネリングこれギリギリっすね。とても面白く聴かせていただきました。

はたのさんのLTはやはりうなづく内容で、あるある…ある…と思いながら聴いていました。

blog枠で行ってるのに、仕事が19時終わりのため毎回遅れるのをなんとかしたいですねえ…